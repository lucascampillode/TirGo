{% extends "base.html" %}
{% block title %}TirGoPharma · Diagnóstico{% endblock %}
{% block content %}
<section class="panel">
  <h2>Diagnóstico guiado</h2>
  <p class="muted">Responde a las preguntas y te recomendaré la opción más segura.</p>

  <div class="progress"><div id="prog"></div></div>

  <form id="wiz" class="form">
    <div class="step" data-step="1">
      <h4>1) Síntoma principal</h4>
      <select name="sx" required>
        <option value="">— Selecciona —</option>
        <option value="dolor">Dolor leve o moderado</option>
        <option value="fiebre">Fiebre</option>
        <option value="resfriado">Resfriado/congestión</option>
        <option value="tos">Tos</option>
        <option value="infeccion">Posible infección</option>
      </select>
    </div>

    <div class="step" data-step="2">
      <h4>2) Edad</h4>
      <select name="edad" required>
        <option value="">— Selecciona —</option>
        <option value="adulto">Adulto (≥ 18)</option>
        <option value="adolescente">Adolescente (12–17)</option>
        <option value="nino">Niño (6–11)</option>
      </select>
    </div>

    <div class="step" data-step="3">
      <h4>3) ¿Alergia a AINEs?</h4>
      <select name="aine" required>
        <option value="">— Selecciona —</option>
        <option value="no">No</option>
        <option value="si">Sí</option>
      </select>
    </div>

    <div class="step" data-step="4">
      <h4>4) Problemas gástricos</h4>
      <select name="gastric" required>
        <option value="">— Selecciona —</option>
        <option value="no">No</option>
        <option value="si">Sí</option>
      </select>
    </div>

    <div class="step" data-step="5">
      <h4>5) Anticoagulantes</h4>
      <select name="aco" required>
        <option value="">— Selecciona —</option>
        <option value="no">No</option>
        <option value="si">Sí</option>
      </select>
    </div>

    <div class="step" data-step="6">
      <h4>6) Enfermedad hepática</h4>
      <select name="hep" required>
        <option value="">— Selecciona —</option>
        <option value="no">No</option>
        <option value="si">Sí</option>
      </select>
    </div>

    <div class="step" data-step="7">
      <h4>7) Embarazo o lactancia</h4>
      <select name="preg" required>
        <option value="">— Selecciona —</option>
        <option value="no">No</option>
        <option value="si">Sí</option>
      </select>
    </div>

    <div class="step" data-step="8">
      <h4>8) Duración del síntoma</h4>
      <select name="dur" required>
        <option value="">— Selecciona —</option>
        <option value="agudo">&lt; 3 días</option>
        <option value="subagudo">3–14 días</option>
        <option value="cronico">&gt; 14 días</option>
      </select>
    </div>

    <div class="actions space">
      <button class="btn" type="button" id="prev">⬅ Anterior</button>
      <div class="muted small" id="stepTxt">Paso 1 / 8</div>
      <button class="btn primary" type="button" id="next">Siguiente ➡</button>
    </div>
  </form>

  <div id="result" class="result card" style="display:none;">
    <h3 id="rTitle">Resultado</h3>
    <p id="rMsg" class="muted"></p>

    {# cuando hay medicamento --> mandamos med_id #}
    <form id="rForm" method="post" action="{{ url_for('leer.leer') }}" style="display:none;">
      <input type="hidden" name="med_id" id="rMed" />
      <button class="btn success" type="submit">Pedir este</button>
      <a class="btn" href="{{ url_for('diagnostico.diagnostico') }}">Volver a empezar</a>
    </form>

    {# cuando es médico / receta #}
    <div id="rDoctor" style="display:none;">
      <p class="warn"><b>Recomendación: visita a tu médico</b></p>
      <a class="btn" href="{{ url_for('main.index') }}">Volver al inicio</a>
    </div>

    {# cuando es consejo sin medicación #}
    <div id="rAdvice" style="display:none;">
      <a class="btn" href="{{ url_for('main.index') }}">Volver al inicio</a>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const form = document.getElementById('wiz'); if(!form) return;
  const steps = [...form.querySelectorAll('.step')];
  const total = steps.length;
  const prog  = document.getElementById('prog');
  const stepTxt = document.getElementById('stepTxt');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');
  let idx = 0;

  // ⚠️ Mapea tus nombres a los IDs reales de tu tabla
  const MED_ID_MAP = {
    "Paracetamol 1g": "101",
    "Ibuprofeno 400 mg": "202",
    "Amoxicilina 500 mg": "303",
    "Omeprazol 20 mg": "404"
  };

  const show = i => {
    idx = Math.max(0, Math.min(total-1, i));
    steps.forEach((el,k)=> el.style.display = (k===idx?'block':'none'));
    const pct = Math.round(((idx)/ (total)) * 100);
    if (prog) prog.style.width = Math.max(6, pct) + '%';
    stepTxt.textContent = `Paso ${idx+1} / ${total}`;
    btnPrev.disabled = idx===0;
    btnNext.textContent = idx===total-1 ? 'Ver resultado' : 'Siguiente ➡';
  };

  const validateStep = () => {
    const req = steps[idx].querySelectorAll('select[required], input[required]');
    for (const r of req){ if(!r.value){ r.focus(); return false; } }
    return true;
  };

  // lógica adaptada a tus 4 medicamentos + consejo + derivación
  const computeRecommendation = () => {
    const data = Object.fromEntries(new FormData(form).entries());

    // 1) casos que deben ir a médico sí o sí
    if (data.dur === 'cronico' || data.hep === 'si') {
      return {
        kind: 'DOCTOR',
        med: null,
        reason: 'Tus síntomas requieren valoración médica presencial.'
      };
    }

    // 2) infección → amoxi, pero con receta
    if (data.sx === 'infeccion') {
      return {
        kind: 'RX',
        med: 'Amoxicilina 500 mg',
        reason: 'Parece un proceso infeccioso. La amoxicilina 500 mg requiere receta y debe pautarla un médico.'
      };
    }

    // 3) problemas gástricos → omeprazol
    if (data.gastric === 'si') {
      return {
        kind: 'MED',
        med: 'Omeprazol 20 mg',
        reason: 'Refieres molestias gástricas. Se puede usar Omeprazol 20 mg de forma puntual. Si empeora, acude a tu médico.'
      };
    }

    // 4) dolor o fiebre → ibuprofeno si puede, si no paracetamol
    if (data.sx === 'dolor' || data.sx === 'fiebre') {
      const aine_risk = (data.aine === 'si') || (data.aco === 'si') || (data.preg === 'si');
      if (aine_risk) {
        return {
          kind: 'MED',
          med: 'Paracetamol 1g',
          reason: 'Dolor/fiebre con factores de riesgo para AINEs: Paracetamol 1g es la opción más segura.'
        };
      } else {
        return {
          kind: 'MED',
          med: 'Ibuprofeno 400 mg',
          reason: 'Dolor/fiebre en persona sin contraindicaciones: Ibuprofeno 400 mg.'
        };
      }
    }

    // 5) resfriado/tos leve y agudo → consejo sin medicación
    if ((data.sx === 'resfriado' || data.sx === 'tos') && data.dur === 'agudo') {
      return {
        kind: 'ADVICE',
        med: null,
        reason: 'Parece un cuadro leve. Descansa, hidrátate bien, puedes tomar vitaminas o miel/limón. Si empeora o dura más de 3–5 días, consulta.'
      };
    }

    // 6) por defecto → paracetamol
    return {
      kind: 'MED',
      med: 'Paracetamol 1g',
      reason: 'Opción segura por defecto.'
    };
  };

  btnPrev.addEventListener('click', ()=> show(idx-1));
  btnNext.addEventListener('click', ()=>{
    if (!validateStep()) return;
    if (idx < total-1){
      show(idx+1);
      return;
    }

    // último paso → calcular
    const res = computeRecommendation();
    const box = document.getElementById('result');
    const rTitle = document.getElementById('rTitle');
    const rMsg = document.getElementById('rMsg');
    const rForm = document.getElementById('rForm');
    const rMed  = document.getElementById('rMed');
    const rDoc  = document.getElementById('rDoctor');
    const rAdvice = document.getElementById('rAdvice');

    box.style.display = 'block';
    rForm.style.display = 'none';
    rDoc.style.display = 'none';
    rAdvice.style.display = 'none';

    if (res.kind === 'DOCTOR') {
      rTitle.textContent = 'Derivado a médico';
      rMsg.textContent = res.reason;
      rDoc.style.display = 'block';
    } else if (res.kind === 'RX') {
      rTitle.textContent = 'Necesita receta médica';
      rMsg.textContent = res.reason;
      rDoc.style.display = 'block';
    } else if (res.kind === 'ADVICE') {
      rTitle.textContent = 'Recomendación sin medicación';
      rMsg.textContent = res.reason;
      rAdvice.style.display = 'block';
    } else {
      // MED → aquí sí mandamos al /leer con med_id
      rTitle.textContent = 'Recomendación disponible';
      rMsg.textContent = res.reason;

      const medId = MED_ID_MAP[res.med] || '';
      rMed.value = medId;   // <input name="med_id" ...>
      rForm.style.display = 'block';
    }

    window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
  });

  show(0);
})();
</script>
{% endblock %}
