{% extends "base.html" %}
{% block title %}TirGoPharma · Dime “hola”{% endblock %}

{% block content %}
<section class="await-shell">
  <div class="await-card row">
    <div class="await-icon-box">
      <div class="await-icon" aria-label="Micrófono">
        <svg class="mic-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z" />
          <path d="M5 11a1 1 0 0 0-2 0 9 9 0 0 0 8 8.94V22a1 1 0 0 0 2 0v-2.06A9 9 0 0 0 21 11a1 1 0 0 0-2 0 7 7 0 0 1-14 0Z" />
        </svg>
      </div>

    </div>

    <div class="await-body">
      <h1 class="await-title">Di <span>“hola, Tirgo”</span></h1>
      <p class="await-sub">Estoy escuchando… cuando te oiga desbloquearé las opciones.</p>

      <div class="await-actions">
        {# le ponemos id para pillarlo en JS #}
        <form id="simulate-form" method="post" action="{{ url_for('main.simulate_hola') }}">
          <button class="btn primary" type="submit">Simular “hola” (demo)</button>
        </form>
        <button class="btn" type="button" onclick="location.reload()">Recargar</button>
      </div>

      <p class="await-hint">Consejo: di la frase completa cerca del micro. Si no funciona, revisa el nodo de voz.</p>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // 1) seguimos chequeando si se activa solo
  async function tick() {
    try {
      const r = await fetch('/session_status', { cache: 'no-store' });
      const j = await r.json();
      if (j && j.active) { location.reload(); return; }
    } catch (e) {}
    setTimeout(tick, 800);
  }
  tick();

  // 2) interceptar el submit para que no muestre el JSON
  const form = document.getElementById('simulate-form');
  if (form) {
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault(); // no navegues
      try {
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
        // si ha ido bien, recargamos para que el index ya vea la sesión activa
        if (resp.ok) {
          location.reload();
        }
      } catch (err) {
        console.warn('No se pudo simular hola:', err);
      }
    });
  }
</script>
{% endblock %}
